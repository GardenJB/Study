## 저장 프로시저 / 사용자 정의 함수

: SQL Server 제공 프로그래밍 기능 ( 데이터베이스 개체)

: 쿼리문의 집합 → 어떤 동작 일괄 처리 때 사용

- 모듈화

```sql
* 저장(생성)	
CREATE PROCEDURE 프로시저명 -- 명칭 usp_... 권장
 AS
		프로시저 실행 SQL문...;
 GO
	

* 실행
 EXEC 프로시저명;

* 매개변수 사용 ⭐⭐
	
	- 입력 매개변수

	@매개변수명 데이터형식 [= 디폴트 값]

	EXECUTE/EXEC 프로시저명 [전달값]

	- 출력 매개변수 : 프로시저 결과 출력 가능

	@매개변수명 데이터형식 OUTPUT
	
	EXEC 프로시저명 @매개변수명 OUTPUT

	** 테이블 형식 사용자 정의 데이터 형식  > 매개변수로 활용
			CREATE TYPE 지정데이터형식명 AS TABLE
		
			@tblPara 지정데이터형식명 READONLY -- 테이블 형식 매개변수는 READONLY 붙여야 함 ⭐ 
				

* 프로그래밍 기능
	- RETURN 사용 성공/실패 조회
	- 프로시저 내 오류 처리 > @@ERROR / TRY,CATCH
	- 임시 저장 프로시저 > #(로컬) / ##(전역)

** CREATE PROC 프로시저명 WITH ENCRYPTION > 암호화
			>> 다시 소스코드를 알아낼 수 없음 주의!
				>> 프로시저 실행 전 원 소스코드 별도 보관 필요

```

```sql
* 저장 프로시저의 특징
	- SQL Server 성능 향상
	- 유지관리 간편
	- 모듈식 프로그래밍 가능
	- 보안 강화
	- 네트워크 전송량 감소

* 종류
	* 사용자 정의 저장 프로시저
		- T-SQL 저장 프로시저
				> usp_ 접두어 권장

		- CLR 저장 프로시저
				> .NET Framework

	* 확장 저장 프로시저
	
	* 시스템 저장 프로시저
		> sp_ 접두어

	
* 저장 프로시저 작동

	- 일반 T-SQL 
			: T-SQL > 구문분석 > 개체 이름 확인 > 사용권한 확인 
				> 최적화 > 컴파일 및 실행계획 등록 > (실행계획 / 캐시 메모리)
				> 실행

			(	동일 T-SQL > 캐시 메모리 확인 > ( 실행계획) > 실행
					>> 실행 단축! >> 현실적 불가(철자 모두 같아야 함)  )

	- 저장 프로시저
			: 프로시저 > 개체 이름 확인 > 사용권한 확인
				> 최적화 > 컴파일 및 실행계획 등록 > (메모리) 
				> 실행

			>> 저장 프로시저 실행 > 메모리 확인 > (실행계획) > 실행 ⭐⭐
  

* WITH RECOMPILE 옵션과 문제점  // 매개변수 스니핑
	> 최적화 단계(인덱스 여부 결정) > 메모리 고정 >> 컴파일 다시할 필요 생김
		: EXEC ... WITH RECOMPILE
			CREATE PROCEDURE ... WITH RECOMPILE
			sp_recompile 테이블명
			DBCC FREEPROCCACHE
```

```sql
* 사용자 정의 함수
		> 복잡한 프로그래밍
		> RETURN문 특정값 반환
		> SELECT문 안에서 보통 실행

	>> 스키마명.함수명(변수값)

* 스칼라 함수
	: RETURN 문에 의해 `단일값`을 반환하는 함수
	: ex) 대부분의 시스템 함수

	
* 사용자 정의 테이블 반환 함수 (테이블 함수)
		: 반환값이 테이블인 함수
		
		- 인 라인 테이블 반환 함수 
				: (뷰와 비슷한 역할)
					별도의 내용 x
					SELECT문 결과를 집합으로 반환

			CREATE FUNCTION 함수명(매개 변수)
					RETURNS TABLE
			AS
					RETURN (
							단일 SELECT 문장;
					)
			GO
	
		- 다중 문 테이블 반환 함수
			CREATE FUNCTION 함수명(매개변수)
					RETURNS @테이블변수 TABLE
									(열이름과 데이터 형식 정의...)
			AS
					BEGIN
									위(헤더)에서 정의한 테이블변수에 행을 INSERT 시키는 작업들...
					RETURN;
  		END

* 스키마 바운드 함수
	: 참조 테이블, 뷰 등이 수정되지 못하도록 설정한 함수
		WITH SCHEMABINDING 사용

* 테이블 변수 > 임시 테이블 용도로 사용

* 사용자 정의 함수의 제약 사항
	- 함수 내부에서 TRY ... CATCH ... 문 사용 불가
	- 함수 내부에서 CREATE/ALTER/DROP문 사용 불가
	- 오류 발생 시 > 함수 실행 멈춤 & 값 반환 없음 주의 ⭐

** 저장 프로시저 > EXECUTE/EXEC
	 함수 > SELECT
		: 함수는 조회를 제외한 나머지 데이터 조작 구현이 힘듦
			함수는 RETURN 필수
			함수는 식의 부분으로 사용가능
			프로시저는 단독 SQL문으로 호출
			보통 함수는 코드 값이나 간단한 결과 추출용
			프로시저는 DML(에러 발생시 메시지와 코드 RETURN 받는 등)이나 다수의 결과 항목 받을 때 사용
			함수 프로시저는 안 되는 테이블 조회 활용 가능
					CREATE FUNCTION 함수명(매개변수)
						...
	
					SELECT 열, 열 , dbo.함수명(변수명) FROM 테이블명;  // 함수 사용 개체 이름에 꼭 스키마명 지정 필요
						 
			
** 작은 데이터 임시 사용 > 테이블 변수
	 대용량 데이터 임시 사용 > 임시 테이블  // 비클리스터형 인덱스 생성 가능
```